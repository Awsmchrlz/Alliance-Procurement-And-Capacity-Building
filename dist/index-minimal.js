var d=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(s,t)=>(typeof require<"u"?require:s)[t]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});import"dotenv/config";import i from"express";import r from"path";import{fileURLToPath as h}from"url";var g=h(import.meta.url),f=r.dirname(g);process.env.NODE_OPTIONS="--max-old-space-size=128 --optimize-for-size";var o=i();o.use(i.json({limit:"1mb"}));o.use(i.urlencoded({extended:!1,limit:"1mb"}));o.use((e,s,t)=>{e.path.startsWith("/api")&&process.env.NODE_ENV!=="production"&&console.log(`${e.method} ${e.path}`),t()});var l=0;o.use((e,s,t)=>{l++,l%10,t()});o.get("/api/health",(e,s)=>{let t=process.memoryUsage();s.json({status:"ok",heap:Math.round(t.heapUsed/1024/1024)+"MB"})});o.post("/api/auth/login",(e,s)=>{s.status(503).json({message:"Database operations disabled in minimal mode"})});var c=r.join(f,"../public");o.use(i.static(c,{maxAge:"1d",etag:!1,lastModified:!1,index:"index.html"}));o.get("*",(e,s)=>{if(e.path.startsWith("/api"))return s.status(404).json({message:"API disabled in minimal mode"});let t=r.join(c,"index.html");if(!d("fs").existsSync(t))return s.status(404).json({message:"Client not built",hint:"Run 'npm run build:client' first"});s.sendFile(t,u=>{u&&s.status(500).json({message:"File error"})})});o.use((e,s,t,p)=>{t.status(500).json({message:"Error"})});var m=process.env.PORT||5005,n=o.listen(m,"0.0.0.0",()=>{let e=process.memoryUsage();console.log(`\u{1F680} Minimal server on port ${m}`),console.log(`\u{1F4BE} Memory: ${Math.round(e.heapUsed/1024/1024)}MB`)});n.timeout=15e3;n.keepAliveTimeout=3e4;n.headersTimeout=31e3;n.maxConnections=20;var a=()=>{n.close(()=>process.exit(0)),setTimeout(()=>process.exit(1),5e3)};process.on("SIGTERM",a);process.on("SIGINT",a);process.on("uncaughtException",()=>{console.error("Uncaught exception - restarting"),a()});process.on("unhandledRejection",()=>{console.error("Unhandled rejection - restarting"),a()});var U=o;export{U as default};
